# Pikachu n8n (Podman, rootless) + Postgres + Redis + Caddy (Let's Encrypt)

Production-grade n8n automation platform running on rootless Podman with automatic SSL certificates, encrypted backups, and simple Caddy reverse-proxying.

---

## ğŸ¯ Quick Start

### 1. Set Your User ID

First, determine your user ID and configure it in `.env`:

```bash
# Get your user ID
id -u

# Edit .env and set PODMAN_UID (and other values) to the value above
cp .env.example .env
nano .env
```

**Example `.env` snippet:**
```bash
PODMAN_UID=1000  # Replace with your actual UID
N8N_ENCRYPTION_KEY=generate-a-long-random-secret
POSTGRES_PASSWORD=strong-db-password
BACKUP_PASSPHRASE=strong-backup-passphrase
RCLONE_REMOTE=pcloud-crypt
RCLONE_REMOTE_PATH=backups/n8n
# Set VOL_TRAEFIK_ACME to your Caddy data volume so certs are backed up:
VOL_TRAEFIK_ACME=pikachu_caddy_data
```

### 2. Protect Your .env

All secrets live in `.env`. Lock it down:

```bash
chmod 600 .env
```

**âš ï¸ Critical:** Ensure `N8N_ENCRYPTION_KEY` is long, random, and stored safely forever (losing this key means losing encrypted workflow credentials).

### 3. Install Dependencies and Prepare Environment

```bash
cd /code/pikachu

# Make scripts executable
chmod +x scripts/*.sh

# Run installation script (primes backups, installs helpers)
./scripts/install-rootless.sh
```

### 4. Configure Encrypted Cloud Backup (Optional but Recommended)

Set up rclone for encrypted backups to pCloud:

```bash
rclone config

# Follow the prompts to:
# 1. Create "pcloud" remote (OAuth-based pCloud connection)
# 2. Create "pcloud-crypt" remote (crypt layer over pcloud)
```

**Backup configuration details:**
- **Remote name:** `pcloud-crypt`
- **Type:** `crypt`
- **Remote:** `pcloud:/backups/pikachu-n8n`
- **Encryption:** Standard (recommended)

### 5. Start the Stack

```bash
# Bring up all containers
./scripts/up.sh

# Verify everything is running correctly
./scripts/verify.sh
```

**Expected output from verify.sh:**
- âœ… All containers running
- âœ… Postgres accepting connections
- âœ… Redis responding to PING
- âœ… n8n web interface accessible

### 6. Access Your Services

**Main Service:**
- **n8n Automation:** https://n8n.kamleshmerugu.me

**First-time setup:**
1. Navigate to https://n8n.kamleshmerugu.me
2. Create your admin account
3. Start building workflows!

---

## ğŸ’¾ Backup & Restore

### Creating Backups

Run manual backup:

```bash
./scripts/backup.sh
```

**What gets backed up:**
- Postgres database dump (compressed)
- n8n data directory
- Redis persistence files
- Configuration files
- Encrypted and uploaded to pCloud

**Backup naming:** `backup-YYYY-MM-DD-HHMMSS.tar.gz.enc`

### Restoring from Backup

```bash
# List available backups
rclone ls pcloud-crypt:

# Restore specific backup
./scripts/restore.sh <TIMESTAMP>

# Example:
./scripts/restore.sh 2025-01-28-143022

# Verify restoration
./scripts/verify.sh
```

**âš ï¸ Restore Warning:** Restoration will overwrite current data. Ensure you have a recent backup before major changes.

---

## ğŸ”„ Automatic Container Updates

Enable automatic image updates using Podman's native auto-update feature:

```bash
# Enable auto-update timer (checks daily)
systemctl --user enable --now podman-auto-update.timer

# Check timer status
systemctl --user list-timers | grep podman-auto-update

# Manual update check
podman auto-update
```

**How it works:**
- Containers are labeled with `io.containers.autoupdate=image`
- Timer checks daily for new images
- If updates found, containers are automatically recreated
- Systemd integration ensures services restart properly

**Update policy:** Conservative - only pulls updates for same tag (e.g., `stable` stays on `stable`)

---

## ğŸ“‹ Setup Checklist

Run this complete setup from the server:

```bash
cd /code/pikachu

# âœ… Step 1: Set correct UID
id -u
# Edit .env and set PODMAN_UID to that number (and all secrets)
cp .env.example .env
nano .env

# âœ… Step 2: Secure .env (contains secrets)
chmod 600 .env

# âœ… Step 3: Install and prepare environment
./scripts/install-rootless.sh

# âœ… Step 4: Configure rclone (optional but recommended)
rclone config

# âœ… Step 5: Bring up the stack
./scripts/up.sh

# âœ… Step 6: Verify everything works
./scripts/verify.sh

# âœ… Step 7: Enable auto-updates (optional)
systemctl --user enable --now podman-auto-update.timer

# âœ… Step 8: Test backup
./scripts/backup.sh

# âœ… Step 9: Access your n8n instance
echo "Visit: https://n8n.kamleshmerugu.me"
```

---

## ğŸ“ Project Structure

```
/code/pikachu/
â”œâ”€â”€ README                       # This file
â”œâ”€â”€ .env                         # Configuration + secrets (chmod 600)
â”œâ”€â”€ podman-compose.yml           # Podman Compose definition
â”œâ”€â”€ Caddyfile                    # Caddy reverse proxy + TLS
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ install-rootless.sh      # Initial setup script
â”‚   â”œâ”€â”€ up.sh                    # Start all containers
â”‚   â”œâ”€â”€ down.sh                  # Stop all containers
â”‚   â”œâ”€â”€ verify.sh                # Health check script
â”‚   â”œâ”€â”€ backup.sh                # Backup script
â”‚   â””â”€â”€ restore.sh               # Restore script
â”œâ”€â”€ data/                        # Container volumes (auto-created)
â”‚   â”œâ”€â”€ n8n/
â”‚   â”œâ”€â”€ postgres/
â”‚   â””â”€â”€ redis/
â””â”€â”€ backups/                     # Local backup staging (auto-created)
```

---

## ğŸ”§ Troubleshooting

### Containers won't start

```bash
# Check container logs
podman logs pikachu-n8n
podman logs pikachu-postgres
podman logs pikachu-caddy

# Check if ports are already in use
ss -tulpn | grep -E ':(80|443|5432|6379)'

# Verify pod is running
podman pod ps
```

### SSL certificate issues

```bash
# Check Caddy logs
podman logs pikachu-caddy

# Verify DNS is pointing correctly and ports 80/443 are reachable
dig n8n.kamleshmerugu.me
curl -I http://n8n.kamleshmerugu.me
```

### Database connection errors

```bash
# Test Postgres connection (adjust if you changed user/db)
podman exec -it pikachu-postgres psql -U "${POSTGRES_USER}" -d "${POSTGRES_DB}"

# Check if password matches in .env
grep POSTGRES_PASSWORD .env
```

### Permission denied errors

```bash
# Verify ownership of data directories
ls -la data/

# Fix ownership if needed
podman unshare chown -R 1000:1000 data/
```

### Backup/restore failures

```bash
# Test rclone connection
rclone ls pcloud-crypt:

# Verify encryption key is correct
grep N8N_ENCRYPTION_KEY .env

# Check available disk space
df -h
```

---

## ğŸ›¡ï¸ Security Considerations

- **Rootless Podman:** All containers run as non-root user
- **Encrypted backups:** All backups encrypted before cloud upload
- **Secret management:** Sensitive data stored in `.env` (chmod 600)
- **HTTPS only:** Let's Encrypt certificates via Caddy
- **Network isolation:** Containers communicate via dedicated Podman network

---

## ğŸ“š Additional Resources

- [n8n Documentation](https://docs.n8n.io/)
- [Podman Documentation](https://docs.podman.io/)
- [Caddy Documentation](https://caddyserver.com/docs/)
- [rclone Documentation](https://rclone.org/docs/)

---

## ğŸ“ License

This setup configuration is provided as-is for personal and commercial use.

## ğŸ¤ Support

For issues or questions:
1. Check the troubleshooting section above
2. Review container logs: `podman logs <container-name>`
3. Verify configuration: `./scripts/verify.sh`

---

**Last Updated:** 2025-01-28  
**Maintainer:** Kamlesh Merugu
