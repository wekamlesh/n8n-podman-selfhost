# Pikachu n8n (Podman, rootless) + Postgres + Redis + Traefik (Let's Encrypt)

Production-grade n8n automation platform running on rootless Podman with automatic SSL certificates, encrypted backups, and systemd integration.

---

## ğŸ¯ Quick Start

### 1. Set Your User ID

First, determine your user ID and configure it in `.env`:

```bash
# Get your user ID
id -u

# Edit .env and set PODMAN_UID to the value above
nano .env
```

**Example `.env` snippet:**
```bash
PODMAN_UID=1000  # Replace with your actual UID
```

### 2. Configure Secrets

Create and secure your secrets file:

```bash
# Set strict permissions on secrets file
chmod 600 .env.secrets

# Edit secrets file
nano .env.secrets
```

**âš ï¸ Critical:** Ensure `N8N_ENCRYPTION_KEY` is:
- Long (32+ characters)
- Randomly generated
- Stored safely forever (losing this key means losing encrypted workflow credentials)

**Example `.env.secrets`:**
```bash
N8N_ENCRYPTION_KEY=your-very-long-random-encryption-key-here
POSTGRES_PASSWORD=your-secure-postgres-password
N8N_DB_PASSWORD=your-secure-n8n-db-password
REDIS_PASSWORD=your-secure-redis-password
TRAEFIK_DASHBOARD_PASSWORD=your-bcrypt-hashed-password
```

### 3. Install Dependencies and Prepare Environment

```bash
cd /code/pikachu

# Make scripts executable
chmod +x scripts/*.sh

# Run installation script (installs Podman, creates networks, etc.)
./scripts/install-rootless.sh
```

### 4. Configure Encrypted Cloud Backup (Optional but Recommended)

Set up rclone for encrypted backups to pCloud:

```bash
rclone config

# Follow the prompts to:
# 1. Create "pcloud" remote (OAuth-based pCloud connection)
# 2. Create "pcloud-crypt" remote (crypt layer over pcloud)
```

**Backup configuration details:**
- **Remote name:** `pcloud-crypt`
- **Type:** `crypt`
- **Remote:** `pcloud:/backups/pikachu-n8n`
- **Encryption:** Standard (recommended)

### 5. Start the Stack

```bash
# Bring up all containers
./scripts/up.sh

# Verify everything is running correctly
./scripts/verify.sh
```

**Expected output from verify.sh:**
- âœ… All containers running
- âœ… Postgres accepting connections
- âœ… Redis responding to PING
- âœ… n8n web interface accessible
- âœ… Traefik routing correctly

### 6. Access Your Services

**Main Services:**
- **n8n Automation:** https://n8n.kamleshmerugu.me
- **Traefik Dashboard (optional):** https://traefik.kamleshmerugu.me

**First-time setup:**
1. Navigate to https://n8n.kamleshmerugu.me
2. Create your admin account
3. Start building workflows!

---

## ğŸ’¾ Backup & Restore

### Creating Backups

Run manual backup:

```bash
./scripts/backup.sh
```

**What gets backed up:**
- Postgres database dump (compressed)
- n8n data directory
- Redis persistence files
- Configuration files
- Encrypted and uploaded to pCloud

**Backup naming:** `backup-YYYY-MM-DD-HHMMSS.tar.gz.enc`

### Restoring from Backup

```bash
# List available backups
rclone ls pcloud-crypt:

# Restore specific backup
./scripts/restore.sh <TIMESTAMP>

# Example:
./scripts/restore.sh 2025-01-28-143022

# Verify restoration
./scripts/verify.sh
```

**âš ï¸ Restore Warning:** Restoration will overwrite current data. Ensure you have a recent backup before major changes.

---

## ğŸ”„ Systemd Integration (Auto-start on Boot)

### Enable Boot Persistence

Make services start automatically when the server boots:

```bash
# Create systemd user directory
mkdir -p ~/.config/systemd/user

# Copy service and timer files
cp /code/pikachu/systemd-user/*.service ~/.config/systemd/user/
cp /code/pikachu/systemd-user/*.timer ~/.config/systemd/user/

# Reload systemd
systemctl --user daemon-reload

# Enable and start the n8n service
systemctl --user enable --now pikachu-n8n.service

# Enable and start automatic backup timer (daily backups)
systemctl --user enable --now pikachu-n8n-backup.timer

# Enable lingering (keeps user services running after logout)
loginctl enable-linger $USER
```

### Manage Services

```bash
# Check service status
systemctl --user status pikachu-n8n.service

# View logs
journalctl --user -u pikachu-n8n.service -f

# Restart service
systemctl --user restart pikachu-n8n.service

# Stop service
systemctl --user stop pikachu-n8n.service

# Check backup timer
systemctl --user list-timers
```

---

## ğŸ”„ Automatic Container Updates

Enable automatic image updates using Podman's native auto-update feature:

```bash
# Enable auto-update timer (checks daily)
systemctl --user enable --now podman-auto-update.timer

# Check timer status
systemctl --user list-timers | grep podman-auto-update

# Manual update check
podman auto-update
```

**How it works:**
- Containers are labeled with `io.containers.autoupdate=image`
- Timer checks daily for new images
- If updates found, containers are automatically recreated
- Systemd integration ensures services restart properly

**Update policy:** Conservative - only pulls updates for same tag (e.g., `stable` stays on `stable`)

---

## ğŸ“‹ Setup Checklist

Run this complete setup from the server:

```bash
cd /code/pikachu

# âœ… Step 1: Set correct UID
id -u
# Edit .env and set PODMAN_UID to that number
nano .env

# âœ… Step 2: Secure secrets file
chmod 600 .env.secrets
nano .env.secrets  # Add all required secrets

# âœ… Step 3: Install and prepare environment
./scripts/install-rootless.sh

# âœ… Step 4: Configure rclone (optional but recommended)
rclone config

# âœ… Step 5: Bring up the stack
./scripts/up.sh

# âœ… Step 6: Verify everything works
./scripts/verify.sh

# âœ… Step 7: Enable systemd services
mkdir -p ~/.config/systemd/user
cp systemd-user/*.{service,timer} ~/.config/systemd/user/
systemctl --user daemon-reload
systemctl --user enable --now pikachu-n8n.service
systemctl --user enable --now pikachu-n8n-backup.timer
loginctl enable-linger $USER

# âœ… Step 8: Enable auto-updates
systemctl --user enable --now podman-auto-update.timer

# âœ… Step 9: Test backup
./scripts/backup.sh

# âœ… Step 10: Access your n8n instance
echo "Visit: https://n8n.kamleshmerugu.me"
```

---

## ğŸ“ Project Structure

```
/code/pikachu/
â”œâ”€â”€ README.md                    # This file
â”œâ”€â”€ .env                         # Public configuration (UID, domains, etc.)
â”œâ”€â”€ .env.secrets                 # Sensitive credentials (chmod 600)
â”œâ”€â”€ compose.yaml                 # Podman Compose definition
â”œâ”€â”€ Containerfile.n8n            # Custom n8n image (optional)
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ install-rootless.sh      # Initial setup script
â”‚   â”œâ”€â”€ up.sh                    # Start all containers
â”‚   â”œâ”€â”€ down.sh                  # Stop all containers
â”‚   â”œâ”€â”€ verify.sh                # Health check script
â”‚   â”œâ”€â”€ backup.sh                # Backup script
â”‚   â””â”€â”€ restore.sh               # Restore script
â”œâ”€â”€ systemd-user/
â”‚   â”œâ”€â”€ pikachu-n8n.service      # Main service unit
â”‚   â””â”€â”€ pikachu-n8n-backup.timer # Backup timer unit
â”œâ”€â”€ data/                        # Container volumes (auto-created)
â”‚   â”œâ”€â”€ n8n/
â”‚   â”œâ”€â”€ postgres/
â”‚   â”œâ”€â”€ redis/
â”‚   â””â”€â”€ traefik/
â””â”€â”€ backups/                     # Local backup staging (auto-created)
```

---

## ğŸ”§ Troubleshooting

### Containers won't start

```bash
# Check container logs
podman logs pikachu-n8n
podman logs pikachu-postgres
podman logs pikachu-traefik

# Check if ports are already in use
ss -tulpn | grep -E ':(80|443|5432|6379)'

# Verify pod is running
podman pod ps
```

### SSL certificate issues

```bash
# Check Traefik logs
podman logs pikachu-traefik

# Verify DNS is pointing correctly
dig n8n.kamleshmerugu.me

# Ensure ports 80 and 443 are accessible from internet
curl -I http://n8n.kamleshmerugu.me
```

### Database connection errors

```bash
# Test Postgres connection
podman exec -it pikachu-postgres psql -U n8n -d n8n

# Check if password matches in .env.secrets
grep DB_PASSWORD .env.secrets
```

### Permission denied errors

```bash
# Verify ownership of data directories
ls -la data/

# Fix ownership if needed
podman unshare chown -R 1000:1000 data/
```

### Backup/restore failures

```bash
# Test rclone connection
rclone ls pcloud-crypt:

# Verify encryption key is correct
grep N8N_ENCRYPTION_KEY .env.secrets

# Check available disk space
df -h
```

---

## ğŸ›¡ï¸ Security Considerations

- **Rootless Podman:** All containers run as non-root user
- **Encrypted backups:** All backups encrypted before cloud upload
- **Secret management:** Sensitive data in separate `.env.secrets` file
- **HTTPS only:** Let's Encrypt certificates automatically renewed
- **Network isolation:** Containers communicate via dedicated Podman network
- **Password hashing:** Traefik dashboard uses bcrypt-hashed passwords

---

## ğŸ“š Additional Resources

- [n8n Documentation](https://docs.n8n.io/)
- [Podman Documentation](https://docs.podman.io/)
- [Traefik Documentation](https://doc.traefik.io/traefik/)
- [rclone Documentation](https://rclone.org/docs/)

---

## ğŸ“ License

This setup configuration is provided as-is for personal and commercial use.

## ğŸ¤ Support

For issues or questions:
1. Check the troubleshooting section above
2. Review container logs: `podman logs <container-name>`
3. Verify configuration: `./scripts/verify.sh`

---

**Last Updated:** 2025-01-28  
**Maintainer:** Kamlesh Merugu